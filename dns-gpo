You **cannot directly run Cloudbase-Init** through Group Policy (GPO).
Cloudbase-Init is a *first-boot provisioning engine* that runs **before** the machine joins the domain ‚Äî GPO applies **only after** a VM is already domain-joined.

BUT‚Ä¶ you *can absolutely* deliver the **same DNS-fix logic** AFTER join using GPO in several clean ways.

Below I‚Äôll show you **exactly how to convert the Cloudbase-Init DNS fix** into a GPO version.

---

# ‚úÖ First ‚Äî What You *Can* Do With GPO

GPO **can**:

### ‚úî Push registry changes

(Perfect for clearing and setting DNS SearchList)

### ‚úî Run startup scripts

(Equivalent to what your Cloudbase-Init PowerShell did)

### ‚úî Enforce DNS Suffix Search List

(Native GPO setting)

### ‚úî Disable DNS Devolution

(Native GPO setting)

### ‚úî Ensure DNS never drifts again

(Very important after join)

---

# üö´ What GPO *Cannot* Do

* It **cannot run before OS boot**
* It **cannot replace Cloudbase-Init functionality**
* It **cannot fix the DNS issue *before* domain join**
  (because GPO is applied *after* successful join)

So GPO is **not a replacement** for Cloudbase-Init.
It is a **reinforcement** ‚Äî it ensures your fix stays permanent.

---

# üß∞ So What You Want Is:

### **‚ÄúHow do I enforce the DNS fix via GPO after domain join?‚Äù**

Here‚Äôs how:

---

# üî• **Option 1 ‚Äî Native GPO (Recommended)**

### Path:

**Computer Configuration ‚Üí Administrative Templates ‚Üí Network ‚Üí DNS Client**

Configure these two policies:

### ‚úî **1. DNS Suffix Search List**

Enable ‚Üí
Set value to:

```
corp.example.com
```

### ‚úî **2. Primary DNS Suffix Devolution**

Enable ‚Üí
Set to **Disabled** (or set level = 0)

This GPO alone will make sure:

* The SearchList *only* contains your domain
* Windows does not append devolved suffixes
* Cloudbase-Init settings never get overwritten by DHCP or NLA
* Domain-joined machines stay compliant forever

---

# üî• **Option 2 ‚Äî GPO Startup Script (PowerShell)**

If you prefer an exact 1:1 of your Cloudbase-Init script, use this:

### GPO Path:

**Computer Configuration ‚Üí Policies ‚Üí Windows Settings ‚Üí Scripts (Startup)**

Add a `.ps1` script with:

```powershell
# Clear existing DNS SearchList (if present)
Remove-ItemProperty `
  -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
  -Name 'SearchList' `
  -ErrorAction SilentlyContinue

# Set domain suffix
Set-ItemProperty `
  -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
  -Name 'SearchList' -Value 'corp.example.com'

# Disable devolution
Set-ItemProperty `
  -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
  -Name 'UseDomainNameDevolution' `
  -Type DWord `
  -Value 0
```

### Notes:

* No reboot needed ‚Äî applied on startup.
* This script **exactly mirrors** your Cloudbase-Init logic.

---

# üî• **Option 3 ‚Äî GPP Registry Item (No scripting)**

### Path:

**Computer Configuration ‚Üí Preferences ‚Üí Windows Settings ‚Üí Registry**

Add 2 registry items:

---

### **Registry item #1**

**Action:** Replace
**Hive:** `HKEY_LOCAL_MACHINE`
**Key Path:**

```
SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
```

**Value Name:** `SearchList`
**Type:** REG_SZ
**Value:** `corp.example.com`

---

### **Registry item #2**

**Action:** Replace
**Hive:** `HKEY_LOCAL_MACHINE`
**Key Path:**

```
SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
```

**Value Name:** `UseDomainNameDevolution`
**Type:** REG_DWORD
**Value:** `0`

---

# üß† Summary ‚Äî Best Practice Workflow

| Stage                 | Tool                                 | Purpose                                                  |
| --------------------- | ------------------------------------ | -------------------------------------------------------- |
| **During Deployment** | **Cloudbase-Init**                   | Fix broken DNS settings in SAP Windows image before join |
| **After Domain Join** | **GPO (native DNS Client policies)** | Enforce DNS suffix and disable devolution                |
| Optional              | **GPO Startup Script**               | Mirrors Cloudbase-Init logic for consistency             |
| Optional              | **GPP Registry**                     | GUI version of startup script                            |

This gives you a **full lifecycle fix** even when you cannot modify the base image.

---

# If You Want

I can generate:

### ‚úî A pre-built **GPO XML backup** you can import

### ‚úî A `.ps1` file ready for ‚ÄúStartup Scripts‚Äù

### ‚úî A GPP Registry .REG file

### ‚úî A full write-up for your AD team

Just tell me which format you want.


Correct ‚Äî **Active Directory cannot push *any* GPO, registry preference, startup script, or configuration to a Windows machine until it has successfully joined the domain.**

This is a fundamental rule of how AD + GPO works.

Let‚Äôs break it down cleanly so there‚Äôs no confusion:

---

# ‚úÖ **True Statement**

**A Windows VM MUST be domain-joined before:**

* Group Policies apply
* GPP registry items push
* Startup scripts run (via GPO)
* Security settings apply
* Software installation policies apply
* Loopback GPO applies
* Anything from SYSVOL is downloaded

**No join = no GPO = no AD-based configuration.**

---

# üß† **Why AD Cannot Push Before Join**

Before joining the domain:

* The machine has **no machine account** in AD
* There is **no secure channel (Kerberos/NTLM)** between the machine and a Domain Controller
* SYSVOL cannot be accessed (`\\domain\sysvol`)
* GPSVC (Group Policy service) cannot authenticate
* GPO security filtering cannot match the computer object
* LDAP queries cannot identify the object
* No ‚ÄúDefault Domain Policy‚Äù or ‚ÄúOU Policy‚Äù can target it

There is literally **no trust relationship** to allow AD to send anything.

---

# üî• **BUT ‚Äî there are 2 exceptions people confuse with GPO**

These are **not** GPO or AD:

### ‚úî **1. Cloudbase-Init / User Data**

Runs **before domain join**, controlled by OpenStack/SAP SCI, NOT AD.

### ‚úî **2. Local Group Policy (LGPO)**

Stored locally under `C:\Windows\System32\GroupPolicy`, NOT from AD.

Neither of these are AD GPO.

---

# üß© So the correct lifecycle is:

### **Stage 1: BEFORE JOIN**

Tools you *can* use:

* Cloudbase-Init (user-data PowerShell)
* Ansible over WinRM (if enabled)
* Manual RDP
* Packer/Automation during template creation
* Local scripts

AD cannot reach the machine here.

---

### **Stage 2: JOINING THE DOMAIN**

Once the machine joins:

* A computer account is created
* A secure channel is established
* SYSVOL becomes accessible
* LDAP search for policies works
* Group Policy client can authenticate

Now AD can push config.

---

### **Stage 3: AFTER JOIN**

AD GPO can enforce:

* DNS suffix search list
* Disable devolution
* Startup scripts
* Registry preferences
* Network policies
* Software deployment
* Local user rights and permissions

This is where **GPO fixes your DNS permanently**.

---

# üî• Practical Takeaway for Your SAP SCI Project

### To fix DNS issues **before join**:

‚úî Use Cloudbase-Init (your ps1 user-data)
‚úî Or Ansible+WinRM
‚úî Or manual RDP bootstrap

### To enforce DNS settings **after join**:

‚úî Use AD GPO

* DNS Suffix Search List
* Disable devolution
* Startup Script (if needed)
* GPP Registry

### AD **cannot** fix the DNS problem before join ‚Äî

which is EXACTLY why Cloudbase-Init is required.

---

# üìå Want a quick flowchart of ‚ÄúWho can configure what at which stage‚Äù?

I can give you that next ‚Äî super helpful for documentation or your Jira ticket.


Here are **clean, simple, working Ansible one-liners** to **clear** the DNS SearchList and **set a new one** on Windows servers.

No fluff ‚Äî just the exact commands.

---

# ‚úÖ **One-liner: Clear the DNS SearchList AND set a new one**

(Uses **win_regedit**, safest and most direct)

```bash
ansible windows -m ansible.windows.win_regedit \
  -a 'path=HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters name=SearchList state=absent' \
  -i inventory.ini && \
ansible windows -m ansible.windows.win_regedit \
  -a 'path=HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters name=SearchList type=string data="corp.example.com"' \
  -i inventory.ini
```

### ‚úî First command: removes the existing list

### ‚úî Second command: adds your new clean list

---

# ‚úÖ **Single combined one-liner (semi-compact)**

```bash
ansible windows -i inventory.ini -m ansible.windows.win_regedit -a 'path=HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters name=SearchList state=absent' && \
ansible windows -i inventory.ini -m ansible.windows.win_regedit -a 'path=HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters name=SearchList type=string data="corp.example.com"'
```

---

# ‚úÖ **One-liner using win_shell (if you prefer PowerShell style)**

```bash
ansible windows -i inventory.ini -m ansible.windows.win_shell \
  -a 'Remove-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name SearchList -ErrorAction SilentlyContinue; Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name SearchList -Value "corp.example.com"'
```

---

# üìù Notes

* `SearchList` must be a **comma-separated string** if adding multiple entries.
* No reboot is required **unless** the network stack is already active.
* If you're running this **before** domain join (via Cloudbase-Init), no reboot needed.

---

If you want a version that also **disables DNS devolution** or a version that **sets per-NIC connection-specific suffix**, I can give you that too.







