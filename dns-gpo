You **cannot directly run Cloudbase-Init** through Group Policy (GPO).
Cloudbase-Init is a *first-boot provisioning engine* that runs **before** the machine joins the domain ‚Äî GPO applies **only after** a VM is already domain-joined.

BUT‚Ä¶ you *can absolutely* deliver the **same DNS-fix logic** AFTER join using GPO in several clean ways.

Below I‚Äôll show you **exactly how to convert the Cloudbase-Init DNS fix** into a GPO version.

---

# ‚úÖ First ‚Äî What You *Can* Do With GPO

GPO **can**:

### ‚úî Push registry changes

(Perfect for clearing and setting DNS SearchList)

### ‚úî Run startup scripts

(Equivalent to what your Cloudbase-Init PowerShell did)

### ‚úî Enforce DNS Suffix Search List

(Native GPO setting)

### ‚úî Disable DNS Devolution

(Native GPO setting)

### ‚úî Ensure DNS never drifts again

(Very important after join)

---

# üö´ What GPO *Cannot* Do

* It **cannot run before OS boot**
* It **cannot replace Cloudbase-Init functionality**
* It **cannot fix the DNS issue *before* domain join**
  (because GPO is applied *after* successful join)

So GPO is **not a replacement** for Cloudbase-Init.
It is a **reinforcement** ‚Äî it ensures your fix stays permanent.

---

# üß∞ So What You Want Is:

### **‚ÄúHow do I enforce the DNS fix via GPO after domain join?‚Äù**

Here‚Äôs how:

---

# üî• **Option 1 ‚Äî Native GPO (Recommended)**

### Path:

**Computer Configuration ‚Üí Administrative Templates ‚Üí Network ‚Üí DNS Client**

Configure these two policies:

### ‚úî **1. DNS Suffix Search List**

Enable ‚Üí
Set value to:

```
corp.example.com
```

### ‚úî **2. Primary DNS Suffix Devolution**

Enable ‚Üí
Set to **Disabled** (or set level = 0)

This GPO alone will make sure:

* The SearchList *only* contains your domain
* Windows does not append devolved suffixes
* Cloudbase-Init settings never get overwritten by DHCP or NLA
* Domain-joined machines stay compliant forever

---

# üî• **Option 2 ‚Äî GPO Startup Script (PowerShell)**

If you prefer an exact 1:1 of your Cloudbase-Init script, use this:

### GPO Path:

**Computer Configuration ‚Üí Policies ‚Üí Windows Settings ‚Üí Scripts (Startup)**

Add a `.ps1` script with:

```powershell
# Clear existing DNS SearchList (if present)
Remove-ItemProperty `
  -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
  -Name 'SearchList' `
  -ErrorAction SilentlyContinue

# Set domain suffix
Set-ItemProperty `
  -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
  -Name 'SearchList' -Value 'corp.example.com'

# Disable devolution
Set-ItemProperty `
  -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
  -Name 'UseDomainNameDevolution' `
  -Type DWord `
  -Value 0
```

### Notes:

* No reboot needed ‚Äî applied on startup.
* This script **exactly mirrors** your Cloudbase-Init logic.

---

# üî• **Option 3 ‚Äî GPP Registry Item (No scripting)**

### Path:

**Computer Configuration ‚Üí Preferences ‚Üí Windows Settings ‚Üí Registry**

Add 2 registry items:

---

### **Registry item #1**

**Action:** Replace
**Hive:** `HKEY_LOCAL_MACHINE`
**Key Path:**

```
SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
```

**Value Name:** `SearchList`
**Type:** REG_SZ
**Value:** `corp.example.com`

---

### **Registry item #2**

**Action:** Replace
**Hive:** `HKEY_LOCAL_MACHINE`
**Key Path:**

```
SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
```

**Value Name:** `UseDomainNameDevolution`
**Type:** REG_DWORD
**Value:** `0`

---

# üß† Summary ‚Äî Best Practice Workflow

| Stage                 | Tool                                 | Purpose                                                  |
| --------------------- | ------------------------------------ | -------------------------------------------------------- |
| **During Deployment** | **Cloudbase-Init**                   | Fix broken DNS settings in SAP Windows image before join |
| **After Domain Join** | **GPO (native DNS Client policies)** | Enforce DNS suffix and disable devolution                |
| Optional              | **GPO Startup Script**               | Mirrors Cloudbase-Init logic for consistency             |
| Optional              | **GPP Registry**                     | GUI version of startup script                            |

This gives you a **full lifecycle fix** even when you cannot modify the base image.

---

# If You Want

I can generate:

### ‚úî A pre-built **GPO XML backup** you can import

### ‚úî A `.ps1` file ready for ‚ÄúStartup Scripts‚Äù

### ‚úî A GPP Registry .REG file

### ‚úî A full write-up for your AD team

Just tell me which format you want.


Correct ‚Äî **Active Directory cannot push *any* GPO, registry preference, startup script, or configuration to a Windows machine until it has successfully joined the domain.**

This is a fundamental rule of how AD + GPO works.

Let‚Äôs break it down cleanly so there‚Äôs no confusion:

---

# ‚úÖ **True Statement**

**A Windows VM MUST be domain-joined before:**

* Group Policies apply
* GPP registry items push
* Startup scripts run (via GPO)
* Security settings apply
* Software installation policies apply
* Loopback GPO applies
* Anything from SYSVOL is downloaded

**No join = no GPO = no AD-based configuration.**

---

# üß† **Why AD Cannot Push Before Join**

Before joining the domain:

* The machine has **no machine account** in AD
* There is **no secure channel (Kerberos/NTLM)** between the machine and a Domain Controller
* SYSVOL cannot be accessed (`\\domain\sysvol`)
* GPSVC (Group Policy service) cannot authenticate
* GPO security filtering cannot match the computer object
* LDAP queries cannot identify the object
* No ‚ÄúDefault Domain Policy‚Äù or ‚ÄúOU Policy‚Äù can target it

There is literally **no trust relationship** to allow AD to send anything.

---

# üî• **BUT ‚Äî there are 2 exceptions people confuse with GPO**

These are **not** GPO or AD:

### ‚úî **1. Cloudbase-Init / User Data**

Runs **before domain join**, controlled by OpenStack/SAP SCI, NOT AD.

### ‚úî **2. Local Group Policy (LGPO)**

Stored locally under `C:\Windows\System32\GroupPolicy`, NOT from AD.

Neither of these are AD GPO.

---

# üß© So the correct lifecycle is:

### **Stage 1: BEFORE JOIN**

Tools you *can* use:

* Cloudbase-Init (user-data PowerShell)
* Ansible over WinRM (if enabled)
* Manual RDP
* Packer/Automation during template creation
* Local scripts

AD cannot reach the machine here.

---

### **Stage 2: JOINING THE DOMAIN**

Once the machine joins:

* A computer account is created
* A secure channel is established
* SYSVOL becomes accessible
* LDAP search for policies works
* Group Policy client can authenticate

Now AD can push config.

---

### **Stage 3: AFTER JOIN**

AD GPO can enforce:

* DNS suffix search list
* Disable devolution
* Startup scripts
* Registry preferences
* Network policies
* Software deployment
* Local user rights and permissions

This is where **GPO fixes your DNS permanently**.

---

# üî• Practical Takeaway for Your SAP SCI Project

### To fix DNS issues **before join**:

‚úî Use Cloudbase-Init (your ps1 user-data)
‚úî Or Ansible+WinRM
‚úî Or manual RDP bootstrap

### To enforce DNS settings **after join**:

‚úî Use AD GPO

* DNS Suffix Search List
* Disable devolution
* Startup Script (if needed)
* GPP Registry

### AD **cannot** fix the DNS problem before join ‚Äî

which is EXACTLY why Cloudbase-Init is required.

---

# üìå Want a quick flowchart of ‚ÄúWho can configure what at which stage‚Äù?

I can give you that next ‚Äî super helpful for documentation or your Jira ticket.


Here are **clean, simple, working Ansible one-liners** to **clear** the DNS SearchList and **set a new one** on Windows servers.

No fluff ‚Äî just the exact commands.

---

# ‚úÖ **One-liner: Clear the DNS SearchList AND set a new one**

(Uses **win_regedit**, safest and most direct)

```bash
ansible windows -m ansible.windows.win_regedit \
  -a 'path=HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters name=SearchList state=absent' \
  -i inventory.ini && \
ansible windows -m ansible.windows.win_regedit \
  -a 'path=HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters name=SearchList type=string data="corp.example.com"' \
  -i inventory.ini
```

### ‚úî First command: removes the existing list

### ‚úî Second command: adds your new clean list

---

# ‚úÖ **Single combined one-liner (semi-compact)**

```bash
ansible windows -i inventory.ini -m ansible.windows.win_regedit -a 'path=HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters name=SearchList state=absent' && \
ansible windows -i inventory.ini -m ansible.windows.win_regedit -a 'path=HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters name=SearchList type=string data="corp.example.com"'
```

---

# ‚úÖ **One-liner using win_shell (if you prefer PowerShell style)**

```bash
ansible windows -i inventory.ini -m ansible.windows.win_shell \
  -a 'Remove-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name SearchList -ErrorAction SilentlyContinue; Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name SearchList -Value "corp.example.com"'
```

---

# üìù Notes

* `SearchList` must be a **comma-separated string** if adding multiple entries.
* No reboot is required **unless** the network stack is already active.
* If you're running this **before** domain join (via Cloudbase-Init), no reboot needed.

---

If you want a version that also **disables DNS devolution** or a version that **sets per-NIC connection-specific suffix**, I can give you that too.


Below is a **clean, complete, step-by-step guide** to create and deploy a **GPO that enforces a DNS suffix search list** on Windows servers *after they join the domain*.

This includes **exact clicks**, **paths**, and **settings**.

---

# ‚úÖ **STEP 1 ‚Äî Open Group Policy Management Console (GPMC)**

On a workstation or server with RSAT or GPMC installed:

1. Press **Win + R**
2. Type:

```
gpmc.msc
```

3. Press **Enter**

This opens **Group Policy Management** ‚Äî the **ONLY** tool used for creating/editing GPOs.

---

# ‚úÖ **STEP 2 ‚Äî Create a new GPO**

Inside GPMC:

1. Expand your domain:

```
Forest ‚Üí Domains ‚Üí YOURDOMAIN
```

2. Right-click **Group Policy Objects**
3. Click **New‚Ä¶**
4. Name the GPO:

```
Fix DNS Suffix SearchList
```

5. Click **OK**

---

# ‚úÖ **STEP 3 ‚Äî Edit the GPO and set DNS suffix policy**

Now:

1. Right-click the new GPO (`Fix DNS Suffix SearchList`)
2. Click **Edit**

In the GPO Editor:

### Navigate to:

```
Computer Configuration
    ‚Üí Policies
        ‚Üí Administrative Templates
            ‚Üí Network
                ‚Üí DNS Client
```

### Configure these two policies:

---

## **1. DNS Suffix Search List**

* Double-click **DNS Suffix Search List**
* Set to **Enabled**
* In the text box, enter:

```
corp.example.com
```

(or whatever your correct DNS domain is)

Click **Apply** ‚Üí **OK**

---

## **2. Primary DNS Suffix Devolution**

* Double-click **Primary DNS Suffix Devolution**
* Set to **Disabled**
* Click **Apply** ‚Üí **OK**

This prevents Windows from adding unintended suffixes.

---

# (Optional / If required)

If you prefer to use **Registry Preferences** instead of the built-in DNS Client policy:

Path:

```
Computer Configuration ‚Üí Preferences ‚Üí Windows Settings ‚Üí Registry
```

Add two registry entries:

* `HKLM\System\CurrentControlSet\Services\Tcpip\Parameters\SearchList`
* `HKLM\System\CurrentControlSet\Services\Tcpip\Parameters\UseDomainNameDevolution`

But the **built-in DNS Client policy is cleaner**, so use that unless instructed otherwise.

---

# ‚úÖ **STEP 4 ‚Äî Link the GPO to the proper OU**

To apply the GPO to your servers:

1. In GPMC, find the OU where your SCI Windows servers reside
   Example:

```
Servers
SCI-Windows
Compute-Nodes
Production-Servers
```

2. Right-click the OU
3. Click **Link an Existing GPO‚Ä¶**
4. Select:

```
Fix DNS Suffix SearchList
```

5. Click **OK**

---

# üî• **IMPORTANT**

**GPOs MUST be linked at the OU level where the *computer objects* live.**

‚úî Linking to a user OU = useless
‚úî Linking to the domain root = applies to everything (not recommended)
‚úî Linking to the server OU = correct

---

# ‚úÖ **STEP 5 ‚Äî Move servers into that OU (if not already)**

Use **Active Directory Users and Computers (ADUC)**:

1. Open:

```
dsa.msc
```

2. Locate the server (search if needed):
   Right-click the domain ‚Üí **Find** ‚Üí type hostname

3. Drag the server into the OU where the GPO is linked
   (Or right-click ‚Üí **Move‚Ä¶**)

---

# ‚úÖ **STEP 6 ‚Äî Force the servers to apply the new GPO**

On the Windows VM:

### Run:

```
gpupdate /force
```

If you prefer remote Ansible:

```bash
ansible windows -m ansible.windows.win_shell -a "gpupdate /force" -i inventory.ini
```

Restart may be required depending on whether devolution settings were previously applied.

---

# ‚úÖ **STEP 7 ‚Äî Validate the DNS Suffix SearchList**

On the server:

### Registry validation:

```
reg query HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters /v SearchList
```

Expected:

```
SearchList    REG_SZ    corp.example.com
```

### GPO validation:

```
gpresult /r /scope computer
```

Under **Applied Group Policy Objects**, you should see:

```
Fix DNS Suffix SearchList
```

---

# üéØ **Summary of All Steps**

1. **Open GPMC** (`gpmc.msc`)
2. **Create new GPO** (‚ÄúFix DNS Suffix SearchList‚Äù)
3. **Edit GPO:**

   * Configure ‚Üí DNS Suffix Search List
   * Disable ‚Üí Primary DNS Suffix Devolution
4. **Link GPO to the Server OU**
5. **Move servers into that OU** (ADUC)
6. **Run gpupdate /force**
7. **Verify SearchList and GPO applied**

---

If you want, I can also:

* Generate the **GPO Backup XML** you can import directly
* Create a **diagram** of the GPO flow
* Write a **Jira-ready description** of this GPO process
* Give you an **Ansible command** to detect which servers *don‚Äôt* have the GPO applied yet

Just say the word.


Great question‚Äîand this is one where Windows is annoyingly particular.

I can‚Äôt give you a **single XML file** you can just paste somewhere and ‚ÄúImport GPO‚Äù ‚Äî GPMC backups are actually a **folder structure** with multiple files (including XML) that GPMC generates itself.

What I *can* do is give you a **PowerShell script** that:

1. Creates the GPO with the **exact DNS settings** we discussed
2. Backs it up to a folder
3. That folder is a valid **GPO backup** you can import on any other DC/forest using GPMC (‚ÄúManage Backups / Restore‚Äù)

---

## üîß PowerShell: Create GPO + Backup It (This Produces the XML You Want)

Run this from a domain-joined server/workstation with GPMC/RSAT and appropriate rights:

```powershell
# ===== CONFIGURE THESE VALUES =====
$GpoName    = "Fix DNS Suffix SearchList"
$BackupPath = "C:\GPO-Backups\Fix-DNS-Suffix"
$SearchList = "corp.example.com"   # <- your domain suffix
# ==================================

Import-Module GroupPolicy

# 1. Create GPO if it doesn't exist yet
$gpo = Get-GPO -Name $GpoName -ErrorAction SilentlyContinue
if (-not $gpo) {
    Write-Host "Creating new GPO: $GpoName"
    $gpo = New-GPO -Name $GpoName
} else {
    Write-Host "GPO already exists: $GpoName (GUID: $($gpo.Id))"
}

# 2. Set DNS Suffix Search List via policy registry (DNS Client)
# This mimics the "DNS Suffix Search List" Admin Template setting
$policyKey = "HKLM\Software\Policies\Microsoft\Windows NT\DNSClient"

Set-GPRegistryValue -Name $GpoName `
    -Key $policyKey `
    -ValueName "SearchList" `
    -Type String `
    -Value $SearchList

# 3. Disable DNS devolution (UseDomainNameDevolution = 0)
Set-GPRegistryValue -Name $GpoName `
    -Key $policyKey `
    -ValueName "UseDomainNameDevolution" `
    -Type DWord `
    -Value 0

# 4. Create backup folder if needed
if (-not (Test-Path $BackupPath)) {
    New-Item -Path $BackupPath -ItemType Directory | Out-Null
}

# 5. Backup the GPO (this creates the XML + manifest)
Write-Host "Backing up GPO '$GpoName' to '$BackupPath'..."
Backup-GPO -Name $GpoName -Path $BackupPath -Comment "Fix DNS suffix search list and disable devolution"

Write-Host "Done. GPO backup created at: $BackupPath"
```

### What this gives you

* A folder like:

  ```
  C:\GPO-Backups\Fix-DNS-Suffix\{GPO-GUID-HERE}
  ```
* Inside it you‚Äôll see files like:

  * `Backup.xml`
  * `GPO.xml`
  * `MACHINE\...`
* That folder is a **valid GPO backup** as if you‚Äôd done ‚ÄúBack Up‚Äù from GPMC by hand.

---

## üß™ How to import this backup on another environment

On the **target domain** (with GPMC):

1. Open **Group Policy Management** (`gpmc.msc`)
2. Right-click **Group Policy Objects** ‚Üí **Manage Backups‚Ä¶**
3. Point it at your backup path (e.g., copied from `C:\GPO-Backups\Fix-DNS-Suffix`)
4. Select the `Fix DNS Suffix SearchList` backup
5. Click **Restore‚Ä¶** or **Copy‚Ä¶** as needed

Then link it to your server OU as we described earlier.

---

If you really want, I can also:

* Add to the script: **auto-link the GPO** to a specific OU
* Or generate a **second script** that takes an existing backup and restores it on another domain automatically.


++++++++++++++++++++++++++++++++++++++++++++++++
Great question‚Äîand this is one where Windows is annoyingly particular.

I can‚Äôt give you a **single XML file** you can just paste somewhere and ‚ÄúImport GPO‚Äù ‚Äî GPMC backups are actually a **folder structure** with multiple files (including XML) that GPMC generates itself.

What I *can* do is give you a **PowerShell script** that:

1. Creates the GPO with the **exact DNS settings** we discussed
2. Backs it up to a folder
3. That folder is a valid **GPO backup** you can import on any other DC/forest using GPMC (‚ÄúManage Backups / Restore‚Äù)

---

## üîß PowerShell: Create GPO + Backup It (This Produces the XML You Want)

Run this from a domain-joined server/workstation with GPMC/RSAT and appropriate rights:

```powershell
# ===== CONFIGURE THESE VALUES =====
$GpoName    = "Fix DNS Suffix SearchList"
$BackupPath = "C:\GPO-Backups\Fix-DNS-Suffix"
$SearchList = "corp.example.com"   # <- your domain suffix
# ==================================

Import-Module GroupPolicy

# 1. Create GPO if it doesn't exist yet
$gpo = Get-GPO -Name $GpoName -ErrorAction SilentlyContinue
if (-not $gpo) {
    Write-Host "Creating new GPO: $GpoName"
    $gpo = New-GPO -Name $GpoName
} else {
    Write-Host "GPO already exists: $GpoName (GUID: $($gpo.Id))"
}

# 2. Set DNS Suffix Search List via policy registry (DNS Client)
# This mimics the "DNS Suffix Search List" Admin Template setting
$policyKey = "HKLM\Software\Policies\Microsoft\Windows NT\DNSClient"

Set-GPRegistryValue -Name $GpoName `
    -Key $policyKey `
    -ValueName "SearchList" `
    -Type String `
    -Value $SearchList

# 3. Disable DNS devolution (UseDomainNameDevolution = 0)
Set-GPRegistryValue -Name $GpoName `
    -Key $policyKey `
    -ValueName "UseDomainNameDevolution" `
    -Type DWord `
    -Value 0

# 4. Create backup folder if needed
if (-not (Test-Path $BackupPath)) {
    New-Item -Path $BackupPath -ItemType Directory | Out-Null
}

# 5. Backup the GPO (this creates the XML + manifest)
Write-Host "Backing up GPO '$GpoName' to '$BackupPath'..."
Backup-GPO -Name $GpoName -Path $BackupPath -Comment "Fix DNS suffix search list and disable devolution"

Write-Host "Done. GPO backup created at: $BackupPath"
```

### What this gives you

* A folder like:

  ```
  C:\GPO-Backups\Fix-DNS-Suffix\{GPO-GUID-HERE}
  ```
* Inside it you‚Äôll see files like:

  * `Backup.xml`
  * `GPO.xml`
  * `MACHINE\...`
* That folder is a **valid GPO backup** as if you‚Äôd done ‚ÄúBack Up‚Äù from GPMC by hand.

---

## üß™ How to import this backup on another environment

On the **target domain** (with GPMC):

1. Open **Group Policy Management** (`gpmc.msc`)
2. Right-click **Group Policy Objects** ‚Üí **Manage Backups‚Ä¶**
3. Point it at your backup path (e.g., copied from `C:\GPO-Backups\Fix-DNS-Suffix`)
4. Select the `Fix DNS Suffix SearchList` backup
5. Click **Restore‚Ä¶** or **Copy‚Ä¶** as needed

Then link it to your server OU as we described earlier.

---

If you really want, I can also:

* Add to the script: **auto-link the GPO** to a specific OU
* Or generate a **second script** that takes an existing backup and restores it on another domain automatically.



+++++++

Here are **simple, direct PowerShell commands** you can run to verify whether **your AD account has the rights needed to create or edit GPOs**.

These commands **do NOT require Domain Admin** ‚Äî they simply test whether you have the delegated GPO permissions needed.

---

# ‚úÖ **1. Check if you can CREATE GPOs in the domain**

Run this:

```powershell
(Get-ACL "AD:CN=Policies,CN=System,DC=yourdomain,DC=com").Access |
    Where-Object { $_.IdentityReference -match $env:USERNAME -and $_.ActiveDirectoryRights -match "CreateGroupPolicyContainer" }
```

### ‚úî If you see output

You **CAN** create new GPOs.

### ‚ùå If nothing appears

You **CANNOT** create GPOs (you need delegation).

---

# ‚úÖ **2. Check if you can EDIT an existing GPO**

Pick a GPO name you think you should be able to edit:

```powershell
Get-GPO -Name "Default Domain Policy" | Get-GPPermission -All |
    Where-Object { $_.Trustee.Name -eq $env:USERNAME }
```

or for any GPO:

```powershell
(Get-GPO -All).DisplayName | ForEach-Object {
    Write-Host "`nChecking GPO: $_"
    Get-GPPermission -Name $_ -All |
        Where-Object { $_.Trustee.Name -eq $env:USERNAME }
}
```

### ‚úî If your username appears with:

* **GpoEdit**
* **GpoEditDeleteModifySecurity**

You **CAN edit** GPOs.

---

# ‚úÖ **3. Check if you can LINK GPOs to an OU**

You need rights on the OU itself.

Replace OU path with your server OU:

```powershell
(Get-ACL "AD:OU=Servers,DC=yourdomain,DC=com").Access |
    Where-Object { $_.IdentityReference -match $env:USERNAME -and $_.ActiveDirectoryRights -match "Write" }
```

### ‚úî If you see **Write** or **GenericAll**

You **CAN link GPOs** to that OU.

### ‚ùå If not

You cannot link GPOs.

---

# ‚úÖ **4. Quick ‚ÄúAm I effectively a GPO admin?‚Äù check**

```powershell
gpresult /r | Select-String $env:USERNAME
```

Shows which GPOs apply to YOU (not a permission test, but helps verify access scope).

---

# ‚ö° Recommended Full Test (All-In-One)

This checks:
‚úî Can you create GPOs
‚úî Can you edit GPOs
‚úî Can you link GPOs

```powershell
Write-Host "=== Checking GPO Creation Rights ==="
(Get-ACL "AD:CN=Policies,CN=System,DC=yourdomain,DC=com").Access |
  Where-Object { $_.IdentityReference -match $env:USERNAME -and $_.ActiveDirectoryRights -match "CreateGroupPolicyContainer" }

Write-Host "`n=== Checking GPO Edit Rights ==="
Get-GPO -All | ForEach-Object {
    Get-GPPermission -Name $_.DisplayName -All |
      Where-Object { $_.Trustee.Name -eq $env:USERNAME }
}

Write-Host "`n=== Checking OU Link Rights (Update OU path) ==="
(Get-ACL "AD:OU=Servers,DC=yourdomain,DC=com").Access |
  Where-Object { $_.IdentityReference -match $env:USERNAME -and $_.ActiveDirectoryRights -match "Write" }
```

---

# üß† SUMMARY (Clear & Simple)

| Permission                                     | You Need To‚Ä¶    |
| ---------------------------------------------- | --------------- |
| **CreateGroupPolicyContainer**                 | Create GPOs     |
| **GpoEdit** or **GpoEditDeleteModifySecurity** | Edit GPOs       |
| **Write / GenericAll on OU**                   | Link GPOs to OU |

Running the commands above will show exactly where you stand.

---

If you'd like, I can help you:
‚úî interpret the output
‚úî generate a ‚Äúdelegation request‚Äù to send to AD team
‚úî write a GPO permission audit script for your entire environment

+++++++++++++++++++++++++++++








Thanks for the photo ‚Äî this confirms **exactly** what‚Äôs breaking domain join.

Let‚Äôs analyze what you posted.

---

# üö® **Critical problem #1 ‚Äî DNS ServerAddresses are WRONG**

From the screenshot:

```
InterfaceAlias    ServerAddresses
--------------    ---------------
Ethernet...       {10.10.0.2, 10.10.0.3}
```

Those DNS servers are **SAP/OpenStack infrastructure DNS**, NOT your **Active Directory DNS**.

‚û°Ô∏è This VM will **never** resolve AD SRV records
‚û°Ô∏è This VM will **never** locate a Domain Controller
‚û°Ô∏è `nltest`, domain join, LDAP, Kerberos, RPC will always fail

You must override those DNS servers.

---

# üö® **Critical problem #2 ‚Äî SearchList is full of SAP internal suffixes**

From your `reg query`:

```
SearchList REG_SZ global.cloud.sap,mo.sap.corp,wdc.sap.corp,global.corp.sap
```

This is **exactly the broken SearchList baked into the SAP Windows image**.

This causes Windows to try suffixes in this order before ever attempting your AD domain.

‚û°Ô∏è Name lookups go to SAP DNS
‚û°Ô∏è Wrong suffixes cause timeouts
‚û°Ô∏è DC lookup fails
‚û°Ô∏è Domain join fails

This must be **completely replaced**.

---

# üéØ Here are the EXACT commands you need to run on the VM to fix both issues.

## ‚úÖ **1. Replace DNS servers with your AD DNS servers**

*(replace the IPs with your AD DNS)*

```powershell
Get-DnsClientAdapter | ForEach-Object {
    Set-DnsClientServerAddress -InterfaceIndex $_.InterfaceIndex `
      -ServerAddresses @("10.10.0.10","10.10.0.11")
}
```

Verify:

```powershell
Get-DnsClientServerAddress
```

Expected:

```
10.10.0.10
10.10.0.11
```

---

## ‚úÖ **2. CLEAR the bad SAP SearchList**

```powershell
Remove-ItemProperty `
  -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
  -Name 'SearchList' `
  -ErrorAction SilentlyContinue
```

---

## ‚úÖ **3. SET your correct AD SearchList**

```powershell
Set-ItemProperty `
  -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
  -Name 'SearchList' `
  -Value 'corp.example.com'
```

---

## ‚úÖ **4. Disable DNS devolution (required)**

```powershell
Set-ItemProperty `
  -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
  -Name 'UseDomainNameDevolution' `
  -Type DWord `
  -Value 0
```

---

# üîÑ Now REBOOT the VM

Since these DNS servers and SearchList were active, a reboot ensures fresh resolver state.

```powershell
shutdown /r /t 5
```

---

# üß™ After reboot ‚Äî retest DNS (IMPORTANT)

## Test domain name:

```powershell
nslookup yourdomain.com
```

## Test AD SRV record:

```powershell
nslookup _ldap._tcp.dc._msdcs.yourdomain.com
```

You should now see your domain controllers.

If this works ‚Üí the VM can join the domain.

---

# üî• Final step ‚Äî safe dry-run domain-join test

```powershell
Add-Computer -DomainName yourdomain.com -Credential (Get-Credential) -WhatIf
```

If no errors appear:
‚û°Ô∏è You **CAN** join

If errors appear:
‚û°Ô∏è Paste them here and we‚Äôll analyze ‚Äî but DNS was the root problem.

---

# üéØ Summary of what the screenshot showed

‚úî Wrong DNS servers (`10.10.0.2`, `10.10.0.3`)
‚úî Wrong search suffix list (SAP suffixes)
‚úî VM cannot resolve AD ‚Üí cannot join domain
‚úî Fix is to override DNS + SearchList

---

If you want, I can generate a **single PowerShell script** that completely fixes DNS + SearchList + devolution + reboot, so you can paste it in one shot (or use it in Cloudbase-Init).






++++++++++++++++++++++++++++++++
===============================


Got you. Let‚Äôs keep this tight and practical: one script you can paste into PowerShell on the VM, and one Cloudbase-Init user-data block.

---

## 1) PowerShell script to run **on the VM**

> Run this in an **elevated PowerShell** session on the Windows VM.
> Replace the DNS IPs and domain with your real values.

```powershell
# --- EDIT THESE VALUES FOR YOUR ENVIRONMENT ---
$DnsServers = @('10.10.0.10', '10.10.0.11')   # <-- AD DNS servers
$AdDomain   = 'corp.example.com'              # <-- Your AD DNS domain
# ---------------------------------------------

Write-Host "Setting DNS servers on all adapters..."
Get-DnsClientAdapter | ForEach-Object {
    try {
        Set-DnsClientServerAddress -InterfaceIndex $_.InterfaceIndex `
            -ServerAddresses $DnsServers -ErrorAction Stop
        Write-Host "  OK: $_.InterfaceAlias"
    } catch {
        Write-Warning "  Failed on adapter $($_.InterfaceAlias): $($_.Exception.Message)"
    }
}

Write-Host "Clearing existing DNS SearchList..."
Remove-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
    -Name 'SearchList' -ErrorAction SilentlyContinue

Write-Host "Setting DNS SearchList to $AdDomain ..."
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
    -Name 'SearchList' -Value $AdDomain

Write-Host "Disabling DNS devolution..."
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
    -Name 'UseDomainNameDevolution' -Type DWord -Value 0

Write-Host "`nCurrent DNS server addresses:"
Get-DnsClientServerAddress | Format-Table -AutoSize

Write-Host "`nCurrent SearchList value:"
reg query HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters /v SearchList

Write-Host "`nDNS settings applied. A reboot is recommended before domain join."
# Uncomment this line if you want the script to auto-reboot:
# shutdown.exe /r /t 5 /c "Rebooting to apply DNS changes"
```

After running and (optionally) rebooting:

```powershell
nslookup yourdomain.com
nslookup _ldap._tcp.dc._msdcs.yourdomain.com
```

If both resolve, you‚Äôre ready to `Add-Computer` / Ansible join.

---

## 2) Cloudbase-Init **user-data** (`#ps1`) for deployment

> Paste this into the **User Data** field when creating the VM in SAP SCI.
> Same idea: set DNS servers, clear bad SearchList, set your domain, disable devolution.

```powershell
#ps1
# --- EDIT THESE VALUES FOR YOUR ENVIRONMENT ---
$DnsServers = @('10.10.0.10', '10.10.0.11')   # AD DNS servers
$AdDomain   = 'corp.example.com'              # AD DNS domain
# ---------------------------------------------

Write-Host "Cloudbase-Init: configuring DNS servers..."
Get-DnsClientAdapter | ForEach-Object {
    try {
        Set-DnsClientServerAddress -InterfaceIndex $_.InterfaceIndex `
            -ServerAddresses $DnsServers -ErrorAction Stop
    } catch {
        Write-Warning "Failed to set DNS on adapter $($_.InterfaceAlias): $($_.Exception.Message)"
    }
}

Write-Host "Cloudbase-Init: clearing existing DNS SearchList..."
Remove-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
    -Name 'SearchList' -ErrorAction SilentlyContinue

Write-Host "Cloudbase-Init: setting DNS SearchList to $AdDomain ..."
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
    -Name 'SearchList' -Value $AdDomain

Write-Host "Cloudbase-Init: disabling DNS devolution..."
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
    -Name 'UseDomainNameDevolution' -Type DWord -Value 0

Write-Host "Cloudbase-Init: DNS configuration complete."

# For first-boot via Cloudbase-Init, you typically don't *need* a reboot.
# If you want to force one anyway, uncomment:
# shutdown.exe /r /t 5 /c "Rebooting after DNS configuration"
```

That‚Äôs it:

* Use the **PowerShell script** on existing VMs to fix them.
* Use the **Cloudbase-Init block** on *new* VMs so they come up with correct DNS from first boot.

If you want, next step I can give you a tiny Ansible play that just **checks** DNS servers + SearchList on all SCI Windows VMs so you can see which ones are still using the SAP defaults.







Short answer: **AD itself can‚Äôt fix this before the VM joins the domain**, but you *can* use the DC as a **remote PowerShell jump box** to push the same DNS fix to the VM.

So:

* ‚ùå You **cannot** use GPO / AD to push settings to a VM that isn‚Äôt joined yet.
* ‚úÖ You **can** sit on the DC and use **PowerShell Remoting (WinRM)** to run the DNS-fix script on the VM using the **local admin account** on that VM.
* ‚úÖ Once the VM *is* joined, then GPO from the DC can keep the DNS suffix list correct long-term.

---

## 1) Remote PowerShell from the DC to the VM (before domain join)

**Prereqs on the VM:**

* WinRM enabled (HTTP 5985 or HTTPS 5986)
* Firewall allows that port
* You know a local admin account on the VM (e.g. `.\sms-administrator`)

From the **domain controller** (or any domain-joined admin box), run:

```powershell
# On the DC (or any admin workstation)

$vmIp      = "10.10.0.25"             # VM IP in SCI
$cred      = Get-Credential .\sms-administrator

Invoke-Command -ComputerName $vmIp -Credential $cred -ScriptBlock {
    # --- EDIT THESE FOR YOUR ENV ---
    $DnsServers = @('10.10.0.10','10.10.0.11')   # AD DNS servers
    $AdDomain   = 'corp.example.com'            # AD DNS domain
    # --------------------------------

    Write-Host "Setting DNS servers..."
    Get-DnsClientAdapter | ForEach-Object {
        Set-DnsClientServerAddress -InterfaceIndex $_.InterfaceIndex `
            -ServerAddresses $DnsServers -ErrorAction SilentlyContinue
    }

    Write-Host "Clearing bad SearchList..."
    Remove-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
        -Name 'SearchList' -ErrorAction SilentlyContinue

    Write-Host "Setting SearchList to $AdDomain ..."
    Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
        -Name 'SearchList' -Value $AdDomain

    Write-Host "Disabling DNS devolution..."
    Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
        -Name 'UseDomainNameDevolution' -Type DWord -Value 0
}
```

After that, you can (still on the DC) sanity-check DNS from the VM:

```powershell
Invoke-Command -ComputerName $vmIp -Credential $cred -ScriptBlock {
    nslookup corp.example.com
    nslookup _ldap._tcp.dc._msdcs.corp.example.com
}
```

If those resolve to your DCs, you‚Äôre ready to run the actual join.

---

## 2) After the VM is joined ‚Äì AD / GPO from the DC

Once the VM can join and does:

1. Use **GPMC on the DC** to create the `Fix DNS Suffix SearchList` GPO.
2. Set:

   * `Computer Configuration ‚Üí Policies ‚Üí Administrative Templates ‚Üí Network ‚Üí DNS Client ‚Üí DNS Suffix Search List`
   * `Primary DNS Suffix Devolution` = Disabled
3. Link that GPO to the OU containing your SCI Windows servers.

From that point on:

* The **DC (via GPO)** keeps the DNS suffix list correct.
* You only need the remote PowerShell/Cloudbase-Init fix for **initial boot / pre-join**.

---

So: there‚Äôs no magic ‚ÄúAD-only‚Äù fix for a non-joined VM, but using the DC as your **remote PowerShell control node** is totally valid and might be more comfortable than logging into each VM.

>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>Got it ‚Äî and yes, I see exactly what your AD teammate (Andre) is suggesting.

Let‚Äôs break this down cleanly so you know **when you should and should NOT use this command**, and whether it applies in your situation.

---

# üîç **The command from Andre:**

```
Add-Computer -Credential (Get-Credential) `
  -Options 'JoinWithNewName,AccountCreate' `
  -DomainName 'directory.sci-dev.scs.internal' `
  -NewName 'new-name'
```

And he noted:

> ‚ÄúNewName value is the new hostname‚Ä¶ I think you can do this without it.‚Äù

---

# ‚úÖ **What this command does**

This command attempts a domain join **AND** attempts to:

* **Create a new computer object in AD** (AccountCreate)
* Optionally **rename the computer** during the join (JoinWithNewName)

This requires:

### **1. AD permission to create computer objects**

OR

### **2. The computer object already exists in AD**

AND

### **3. DNS must already be correct**

* Correct DNS servers
* Correct SearchList
* Can resolve `_ldap._tcp.dc._msdcs.<domain>`

---

# ‚ùó **BUT ‚Äî you are NOT ready to run this yet**

You still have:

* ‚ùå Wrong DNS servers
* ‚ùå Wrong DNS SearchList
* ‚ùå Missing AD DNS resolution

Until DNS is fixed:

*No domain join command will ever work*, including Andre‚Äôs.

This is why:

```
nltest /sc_query
RPC_S_Server_UNAVAILABLE
```

You must fix DNS **first**.

---

# üî• **Which flags should you use when DNS is fixed?**

You do **NOT** need the `NewName` option unless you want to *rename the VM* as part of the join.

### If you do NOT want to rename:

Use the simplest form:

```powershell
Add-Computer -DomainName 'directory.sci-dev.scs.internal' -Credential (Get-Credential)
```

### If you WANT to rename the computer during join:

```powershell
Rename-Computer -NewName "new-name" -Restart
Add-Computer -DomainName 'directory.sci-dev.scs.internal' -Credential (Get-Credential)
```

### If you want AD to **create the computer object** automatically:

```powershell
Add-Computer -DomainName 'directory.sci-dev.scs.internal' `
  -Credential (Get-Credential) `
  -Options AccountCreate
```

---

# ü§ù **Your actual next steps (very clear):**

## **1. Fix DNS servers**

Replace with your AD DNS IP addresses:

```powershell
Get-DnsClientAdapter | ForEach-Object {
    Set-DnsClientServerAddress -InterfaceIndex $_.InterfaceIndex `
    -ServerAddresses @("10.x.x.x","10.x.x.y")
}
```

Verify:

```powershell
Get-DnsClientServerAddress
```

---

## **2. Fix DNS SearchList**

Remove SAP‚Äôs garbage suffixes:

```powershell
Remove-ItemProperty `
 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
 -Name 'SearchList' -ErrorAction SilentlyContinue
```

Add your correct AD domain:

```powershell
Set-ItemProperty `
 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
 -Name 'SearchList' -Value 'directory.sci-dev.scs.internal'
```

Disable devolution:

```powershell
Set-ItemProperty `
 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
 -Name 'UseDomainNameDevolution' `
 -Type DWord -Value 0
```

---

## **3. Test DNS resolution**

These **must work**, or domain join will still fail:

```powershell
nslookup directory.sci-dev.scs.internal
```

```powershell
nslookup _ldap._tcp.dc._msdcs.directory.sci-dev.scs.internal
```

If these fail ‚Üí don‚Äôt bother trying to join.

---

## **4. JOIN the domain using a safe test**

Before actually joining, simulate the join:

```powershell
Add-Computer -DomainName 'directory.sci-dev.scs.internal' `
  -Credential (Get-Credential) `
  -WhatIf
```

If that looks good ‚Üí run the real join:

```powershell
Add-Computer -DomainName 'directory.sci-dev.scs.internal' -Credential (Get-Credential)
Restart-Computer
```

---

# üéØ **BOTTOM LINE**

Andre‚Äôs command is correct in principle,
BUT **DNS MUST BE FIXED FIRST** ‚Äî otherwise *any* join method will fail.

Once DNS is fixed, you can use:

‚úî `Add-Computer` (simple join)
‚úî `Add-Computer -Options AccountCreate` (auto-create computer object)
‚úî `Add-Computer -NewName` (rename + join)

---

If you want, paste the AD DNS server IPs you were given, and I‚Äôll generate the exact commands you should run for your environment.

>>>>>>>>>>>>>>>
Cool, let‚Äôs lock this in with something you can *actually* paste and run.
Since I don‚Äôt know your exact AD DNS IPs, I‚Äôll use placeholders ‚Äì you just plug yours in.

I‚Äôll assume your AD domain is:
`directory.sci-dev.scs.internal` (from your screenshot)

---

## 1Ô∏è‚É£ Fix DNS + search list on the VM (run as **Administrator**)

Open an elevated PowerShell on the VM and paste this whole block:

```powershell
# --- EDIT THESE TWO LINES ONLY ---
$Domain     = 'directory.sci-dev.scs.internal'
$DnsServers = @('10.20.30.40','10.20.30.41')   # <-- PUT YOUR AD DNS IPs HERE
# ---------------------------------

Write-Host "Setting DNS servers on all adapters to $($DnsServers -join ', ') ..."
Get-DnsClientAdapter | ForEach-Object {
    Set-DnsClientServerAddress -InterfaceIndex $_.InterfaceIndex `
        -ServerAddresses $DnsServers
}

Write-Host "Clearing any existing DNS SearchList..."
Remove-ItemProperty `
  -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
  -Name 'SearchList' -ErrorAction SilentlyContinue

Write-Host "Setting DNS SearchList to $Domain ..."
Set-ItemProperty `
  -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
  -Name 'SearchList' `
  -Value $Domain

Write-Host "Disabling DNS devolution..."
Set-ItemProperty `
  -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' `
  -Name 'UseDomainNameDevolution' `
  -Type DWord `
  -Value 0

Write-Host "Current DNS servers:"
Get-DnsClientServerAddress | Format-Table -AutoSize

Write-Host "Current global TCP/IP SearchList:"
reg query HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters /v SearchList
```

Check that:

* `Get-DnsClientServerAddress` shows **only** your AD DNS servers.
* `SearchList` now shows just `directory.sci-dev.scs.internal`.

---

## 2Ô∏è‚É£ Test DNS resolution to AD

Still on the VM, run:

```powershell
nslookup $Domain
nslookup _ldap._tcp.dc._msdcs.$Domain
```

Both should return info about your domain / DCs (no timeouts).

If either fails, don‚Äôt try to join yet ‚Äì DNS still isn‚Äôt right.

---

## 3Ô∏è‚É£ Safe ‚Äúdry run‚Äù join test

Once DNS looks good:

```powershell
Add-Computer -DomainName $Domain -Credential (Get-Credential) -WhatIf
```

* If it prints what it *would* do ‚Üí your creds and DNS are good.
* If it errors ‚Üí we read that error and fix whatever it says.

---

## 4Ô∏è‚É£ Actual domain join

When the `-WhatIf` looks clean, do the real join:

```powershell
Add-Computer -DomainName $Domain -Credential (Get-Credential)
Restart-Computer
```

That‚Äôs it ‚Äì this is the exact flow you need on the VM.

---

If you send me your actual AD DNS IPs (or a `Get-DnsClientServerAddress` after you set them), I can swap them into this block so you‚Äôve got a perfectly customized snippet you can just paste.

